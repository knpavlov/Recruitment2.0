# Устранение ошибок SSL/TLS на доменах Railway

## Симптомы

- При открытии `https://recruitment20-frontend-production.up.railway.app` браузер показывает предупреждение вида «Your connection is not private» / `NET::ERR_CERT_AUTHORITY_INVALID`.
- В разделе *Advanced* браузер сообщает о сертификате, выданном неизвестным центром сертификации (CA), или о несоответствии имени домена.

## Почему это происходит

Railway выдаёт бесплатные TLS-сертификаты для поддоменов `*.up.railway.app` через собственную прослойку-прокси. Если служба была недавно пересоздана, перенесена между окружениями или использует новый домен, сертификат может оказаться в одном из следующих состояний:

1. **Сертификат ещё не выпущен.** Railway запрашивает его у доверенного CA (Let's Encrypt) только после того, как сервис успешно отдаёт HTTP-ответы. Пока сертификат не выпущен, прокси может отдавать временный сертификат Railway Proxy CA, который не доверен браузерами.
2. **Сертификат выпущен, но кэш браузера устарел.** После переезда на другой домен или пересоздания сервиса старый сертификат остаётся в HSTS-кэше браузера и приводит к предупреждению.
3. **Локальная сеть подменяет сертификат.** Корпоративные фильтры (например, Cisco Umbrella, Zscaler, Kaspersky) могут расшифровывать трафик через собственный TLS-прокси и выдавать промежуточный сертификат, неподписанный доверенным корневым центром. Именно такая ситуация показана на скриншоте с сертификатом `Cisco Umbrella Secondary SubCA`. Браузер считает эту цепочку недоверенной и сообщает об ошибке.
4. **Сертификат повреждён или не привязан к сервису.** Это случается при ручном удалении домена или неудачной миграции окружения в Railway.

## Как диагностировать проблему

1. **Проверить сертификат с помощью CLI.**
   - **macOS/Linux (bash/zsh):**
     ```bash
     openssl s_client -connect recruitment20-frontend-production.up.railway.app:443 \
       -servername recruitment20-frontend-production.up.railway.app < /dev/null |
       openssl x509 -noout -issuer -subject -dates
     ```
   - **Windows PowerShell:** оператор перенаправления `<` не поддерживается, поэтому используйте конвейер с `echo`.
     ```powershell
     echo '' | openssl s_client -connect recruitment20-frontend-production.up.railway.app:443 `
       -servername recruitment20-frontend-production.up.railway.app |
       openssl x509 -noout -issuer -subject -dates
     ```
     Если установлен только `cmd.exe`-вариант OpenSSL, выполните команду через `cmd /c "echo.| openssl ..."`.
   - Если в поле `issuer` указан `Let's Encrypt`, сертификат корректен, а ошибка идёт со стороны браузера/кэша.
   - Если указан `Railway Proxy CA` или другое неизвестное имя, Railway ещё не выпустил доверенный сертификат.
   - Если вместо Railway/Let's Encrypt отображаются корпоративные прокси (`Cisco Umbrella Secondary SubCA`, `Zscaler Intermediate`, и т. д.), значит трафик перехватывается сетевым фильтром. Проверьте, установлен ли в систему корневой сертификат компании, либо подключитесь к другой сети/VPN.
2. **Убедиться, что сервис отвечает на HTTP.** В Railway откройте вкладку *Deployments* и проверьте, что последний деплой завершён, а вкладка *Metrics* показывает успешные запросы.
3. **Проверить вкладку `Networking → Certificates` в панели Railway.** Там отображаются все домены и статус их SSL.

4. **Сравнить сертификат в разных сетях.** Откройте домен через мобильный интернет или VPN. Если предупреждение исчезает, проблема в локальном фильтре, а не в Railway.

## Как исправить

1. **Принудительно перевыпустить сертификат.**
   - В Railway откройте сервис `Recruitment2.0-frontend`.
   - Перейдите в `Settings → Domains` и нажмите `Refresh certificate` (или удалите и заново добавьте домен `recruitment20-frontend-production.up.railway.app`).
   - Дождитесь статуса *Ready*. Обычно это занимает 1–3 минуты.
2. **Перезапустить сервис после перевыпуска.** Запустите деплой (`Deploy` → `Manual deploy`) или `Restart deployment`, чтобы прокси подхватила новый сертификат.
3. **Очистить кэш браузера/HSTS.** После обновления сертификата удалите запись домена из HSTS:
   - В Chrome откройте `chrome://net-internals/#hsts`, введите домен в блок `Delete domain security policies` и нажмите `Delete`.
   - Либо откройте домен в режиме инкогнито.
4. **Если сертификат подменяет корпоративная сеть.**
   - Установите корневой сертификат организации (обычно ИТ-отдел предоставляет `.crt`/`.cer` файл или устанавливает его через MDM). После этого браузер начнёт доверять цепочке.
   - Либо временно переключитесь на сеть без TLS-инспекции (мобильный hotspot, домашний Wi-Fi, VPN с туннелированием).
   - При невозможности отключить проверку запросите у администраторов добавление домена `recruitment20-frontend-production.up.railway.app` в список исключений.
5. **Проверить локальное время.** Если на клиентском устройстве сброшены дата или часовой пояс, TLS-проверки будут проваливаться даже с корректным сертификатом. Убедитесь, что системные часы синхронизированы.

## Как избежать повторения

- После каждого изменения инфраструктуры (миграция окружений, переименование сервисов) проверяйте вкладку `Networking → Certificates` в Railway.
- Добавьте в чек-лист деплоя пункт «Проверить домен в `https://www.ssllabs.com/ssltest/`». Это позволяет убедиться, что цепочка сертификатов корректна.
- Не запускайте фронтенд через временные домены (`railway.app`), если планируется публичный доступ. Подключите собственный домен — Railway автоматически выпустит Let's Encrypt-сертификат и обновит его до истечения срока.

